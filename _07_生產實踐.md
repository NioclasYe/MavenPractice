# 1. 搭建Maven 私服 Nexus
* 必要項目：
  * 設定setting.xml中的 [mirror標籤](#1212-指定nexus服務器地址)
  * pom.xml
    * [引用jar包](#123-引用他人部署的jar包)
    * [部署jar包](#122-將-jar包-部署到-nexus) 

## 1.1 docker Nexus

1. **啟動指令**
    * AMD架構
        ```shell
        $ docker run -d --name nexus3 --restart=always \
        -p 8081:8081  \
        --mount src=nexus-data,target=/nexus-data \
        sonatype/nexus3
        ```
    * ARM架構
      ```shell
      $ docker run -d -p 8081:8081 \
        --name nexus3 \
        klo2k/nexus3
      ```
2. **查看log日誌**：docker **logs** nexus3 -f
    * 首次`啟動需等待 3~5 分鐘`
3. **獲取密碼**： docker exec nexus3 **cat /nexus-data/admin.password**
4. **登陸 Nexus**
    * **路經**：http://localhost:8081
    * **帳號**：**admin**
    * `登陸後，預設要修改密碼`
    * **選擇禁用匿名訪問**：Disable anonymous access

## 1.2 對接 Nexus

### 1.2.1 通過 Nexus 下載jar包

* Nexus 上的各種倉庫
    * 倉庫類型：
        * proxy：某個遠程倉庫代理
        * group：存放，通過Nexus獲取的第三方jar包
        * hosted：存放：本團隊其他開發人員部署到 Nexus的jar包
    * 倉庫名稱：
        * maven-central：Nexus 對 Maven 中央倉庫的代理
        * maven-public：Nexus 默認創建，供開發人員下載使用的倉庫組合
        * maven-release：Nexus 默認創建，供開發人員部署自己 jar包的宿主倉庫，要求release版本
        * maven-snapshots：Nexus 默認創建，供開發人員部署自己 jar包的宿主倉庫，要求snapshots版本

#### 1.2.1.1 使用空的本地倉庫

* 調整setting.xml中的 **localRepository**
  ```xml
  <localRepository>/Users/nicolas/.m2/repository</localRepository>
  ```

#### 1.2.1.2 指定Nexus服務器地址

* 調整setting.xml中的 **mirror**
    * url來源：點擊 頁面上 Browse --> maven-public 該行的 copy按鈕 --> 複製路徑
        * `http://localhost:8081/repository/maven-public/`
        * 使用 maven-public 倉庫
    ```xml
    <mirror>
      <id>nexus-mine</id>
      <mirrorOf>central</mirrorOf>
      <name>Nexus Mine</name>
      <url>http://localhost:8081/repository/maven-public/</url>
    </mirror> 
   ```

* 如果**選擇禁用匿名訪問**，需要在**配置setting.xml**
    * 注意：server標籤內的**id值**必須和`mirror標籤`中的**id值**一樣。
    * 調整setting.xml中的 **server** （基本配置）
        ```xml
        <servers>
            <server>
                <id>nexus-mine</id>
                <username>admin</username>
                <password>admin</password>
            </server>
        </servers>
        ```
    *  私服配置（公司的gitlab）
        ```xml
        <settings>
            <servers>
                <server>
                    <id>gitea</id>
                    <configuration>
                        <httpHeaders>
                            <property>
                                <name>Authorization</name>
                                <value>token {access_token}</value>
                            </property>
                        </httpHeaders>
                    </configuration>
                </server>
            </servers>
        </settings>
        ```

#### 1.2.1.3 效果

* 找到一個工程，執行指令 => mvn clean compile
    * **效果**：
        * 本地會下載 maven 的 jar包
        * Nexus的maven-public **顯示** `對應本地maven倉庫的目錄結構`
    * 輸出：
    ```text
    Downloading from nexus-mine: http://localhost:8081/repository/maven-public/org/apache/maven/plugins/maven-clean-plugin/3.2.0/maven-clean-plugin-3.2.0.pom
    ```

### 1.2.2 將 jar包 部署到 Nexus

* **部署** pro34-module-micro 到 Nexus

#### 1.2.2.1 配置Maven工程

* **工程名**：pro34-module-micro
* **設定POM**：
    ```xml
     <distributionManagement>
       <repository>
            <!-- id標籤：需要跟mirror中的id標籤值 相同 -->
            <id>nexus-mine</id>
            <name>Nexus Release</name>
            <!-- 使用  maven-release 這個倉庫-->
            <url>http://localhost:8081/repository/maven-release/</url>
        </repository>
        <snapshotRepository>
            <!-- id標籤：需要跟mirror中的id標籤值 相同 -->
            <id>nexus-mine</id>
            <name>Nexus Snapshot</name>
            <!-- 使用  maven-snapshots 這個倉庫-->
            <url>http://localhost:8081/repository/maven-snapshots/</url>
        </snapshotRepository>
    </distributionManagement>
    ```
     * repository 標籤：正式版本
     * snapshotRepository 標籤：快照版本
   
#### 1.2.2.2 執行部署命令

* **命令**：`mvn deploy`

### 1.2.3 引用他人部署的jar包

* **默認訪問的Nexus倉庫**：**maven-public**
    * 在 s**etting.xml中有設定**
      ```xml
      <mirror>
        <id>nexus-mine</id>
        <mirrorOf>central</mirrorOf>
        <name>Nexus Mine</name>
        <url>http://localhost:8081/repository/maven-public/</url>
      </mirror> 
      ```
* **存放別人部署jar包的倉庫**：**maven-snapshots**
    * `自己`或`他人` **上傳的倉庫是**：**maven-snapshots**

#### 1.2.3.1 配置Maven工程

* 設定POM
    * 使用**repository標籤** 設定快照
    * **下載 pro34-module-micro**
    ```xml
    <project xmlns="http://maven.apache.org/POM/4.0.0"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
        <modelVersion>4.0.0</modelVersion>

        <groupId>com.nicolas.maven</groupId>
        <artifactId>pro35-module-mirror-jar</artifactId>
        <version>1.0-SNAPSHOT</version>

        <properties>
            <maven.compiler.source>11</maven.compiler.source>
            <maven.compiler.target>11</maven.compiler.target>
            <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
        </properties>
        
        <dependencies>
            <!-- 添加依賴-->
            <dependency>
                <groupId>com.nicolas.maven</groupId>
                <artifactId>pro34-module-micro</artifactId>
                <version>1.0-SNAPSHOT</version>
            </dependency>
        </dependencies>

        <repositories>
            <repository>
                <!-- id標籤：需要跟mirror中的id標籤值 相同 -->
                <id>nexus-mine</id>
                <name>nexus-mine</name>
                <url>http://localhost:8081/repository/maven-snapshots/</url>
                <snapshots>
                    <enabled>true</enabled>
                </snapshots>
                <releases>
                    <enabled>true</enabled>
                </releases>
            </repository>
        </repositories>
    </project>
   ```

# 2. jar包衝突問題

## 2.1 表現形式

* 一般來說，由於我們自己編寫程式碼、設定檔與寫錯所致的問題通常能夠在異常資訊看到我們自己類別的全類別名稱或設定檔的所在路徑。
    * 如果整個錯誤信急中完全沒有我們負責的部分，全部懸框架、第三方工具包裡面的類別報錯，這往往是由jar包的問題所引起的。
    * 而**具體的表現形式**中，主要體現為**找不到類**或**找不到方法**。

## 2.1.1 拋異常：找不到類

* 此時**拋出的常見的異常類型**：
    * java.lang.**ClassNotFoundException**：**編譯**過程中找不到類
    * java.lang.**NoClassDefFoundError**：**運行過程**中找不到類
    * java.lang.LinkageError：不同類別載入品分別載入的多個類別有相同的全限定名

#### 2.1.1.1 案例

```xml

<dependency>
    <groupId>org.apache.httpcomponents</groupId>
    <artifactId>httpclient</artifactId>
    <version>4.x.x</versions>
</dependency>
```

* httpcomponents 這個jar套件中有一個類別：org.apache.http.conn.ssl.**NoopHostNameVerifier**。 這個類別在**較低版本中沒有**
  ，但在**較高版本存在**。

  | jar包版本 | 是否存在 |
  | --------- | -------- |
  | 4.3.6     | 不存在   |
  | 4.4       | 存在     |

### 2.1.2 拋異常：找不到方法

* 見於透過**反射調用方法**，所以常常會導致：java.lang.**NoSuchMethodError**。
    * 例如：antlr:antlr:x.xx這個包中有一個接口 => antlr.collections.AST

      | jar包版本 | getLine()方法 |
      | --------- | ------------- |
      | 2.7.2     | 無            |
      | 2.7.6     | 有            |

### 2.1.3 沒報錯但結果不對

* **典型原因**：兩個jar包中的類別**分別實作了同一個接口**，這本來是很正常的。
    * 但問題在於由於`沒有注意命名規範`，**兩個不同實現**類別`恰好是同一個名字`。

## 2.2 本質

* 基本上是**兩種情況造成**：
    * 同一個jar包的不同版本
    * 不同jar包中包含同名類

## 2.3 解決方式

* **基本思路**無非是這麼兩步：
    * 第一步：把彼此衝突的jar包我到
    * 第二步：在衝突的jar包中選定一個。
* 具體做法無非是**透過『 exclusions標籤』排除依賴**，或是**明確聲明依賴**。

### 2.3.1 IDEA的MavenHelper插件

* 這個插件是**IDEA中安裝的插件**，`不是Maven插件`。
    * 它能夠給我們羅列出來同一個jar包的不同版本，以及它們的來源。 `但是對不同jar包中同名的類別沒有辦法`。
* **使用**：**打開POM.xml** => **點擊下方的『Dependency Analyzer』**

### 2.3.2 Maven 的  enforcer 插件

* Maven的enforcer播件：既可以檢測**同一個jar包的不同版本**，又可以**檢測不同jar包中同名的類**

#### 2.3.2.1 引入netty依賴

```xml

<dependencies>
    <dependency>
        <groupId>org.jboss.netty</groupId>
        <artifactId>netty</artifactId>
        <version>3.2.10.Final</version>
    </dependency>
    <dependency>
        <groupId>org.jboss.netty</groupId>
        <artifactId>netty</artifactId>
        <version>3.2.9.Final</version>
    </dependency>
</dependencies>
```

#### 2.3.2.2 配置 enforcer 插件

```xml

<build>
    <pluginManagement>
        <plugins>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-enforce-plugin</artifactId>
                <version>1.4.1</version>
                <executions>
                    <execution>
                        <id>enforce-dependencies</id>
                        <phase>validate</phase>
                        <goals>
                            <goal>display-info</goal>
                            <goal>enforce</goal>
                        </goals>
                    </execution>
                </executions>
                <dependencies>
                    <dependency>
                        <groupId>org.codehaus.mojo</groupId>
                        <artifactId>extra-enforcer-rules</artifactId>
                        <version>1.1</version>
                    </dependency>
                </dependencies>
                <configuration>
                    <rules>
                        <banDuplicateClasses>
                            <findAllDuplicates>true</findAllDuplicates>
                        </banDuplicateClasses>
                    </rules>
                </configuration>
            </plugin>
        </plugins>
    </pluginManagement>
</build>
```

* 執行命令： mvn clean package enforcer:enforce

# 3. 非Maven導入

* 而實際開發中確實有可能用到一些jar包並非是用Maven的方式發布，那自然也沒辦法通過Maven導入。
* 此時如果我們能夠拿到該jar包的源碼那還可以自己建一個Maven工程，自己打包。
    * 可是如果連原始碼都沒有呢？這方面的例子包括一些人臉辨識用的jar包、海康視訊監控jar包等等。

## 3.1 解決辦法

### 3.1.1 準備一個體系外jar包

* 創建一個Java工程，非Maven工程
    * 將此Java工程導出
* **導出jar包**
    1. ⌘ + ;
    2. 點擊Project Setting下的Artifacts
    3. 點擊 + 號 => JAR => Empty ，隔壁框就會出現
    4. 點擊 + 號 => Module Output
    5. 點擊 Build => Build Artifacts => Build
* 導出的位置：`/Users/nicolas/MavenPractice/pro36-common-java/out/artifacts/outer/outer.jar`

### 3.1.2 將該jar包 安裝到maven倉庫

* 使用install插件的**install-file目標**：
    ```shell
    mvn install:install-file -Dfile=[體系外iar包路徑]\
    -DgroupId=[給體系外jar包強行設定座標]\
    -DartifactId=[給體系外jar包強行設定座標]\
    -Dyersion=1 \
    -Dpackage=jar
    ```
* **實際**
    ```shell
    mvn install:install-file -Dfile=/Users/nicolas/MavenPractice/pro36-common-java/out/artifacts/outer/outer.jar \
    -DgroupId=com.nicolas.maven \
    -DartifactId=my-outer-1 \
    -Dversion=1 \
    -Dpackaging=jar
    ```
  

### 3.1.2 引入依賴
```xml

<dependencies>
    <dependency>
        <groupId>com.nicolas.maven</groupId>
        <artifactId>my-outer-1</artifactId>
        <version>1</version>
    </dependency>
</dependencies>
```
